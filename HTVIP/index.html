<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»‘é“VIP æ³¨å†Œ</title>
  <link rel="stylesheet" href="https://htcb-12c7.github.io/htgov/css/htgov.css" />
<style>
  .register-box {
    max-width: 400px;
    margin: 40px auto;
    padding: 20px;
    background: #222;
    color: white;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  .register-box h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  .register-box input, 
  .register-box select {
    width: 100%;              /* âœ… ç»Ÿä¸€é•¿åº¦ */
    box-sizing: border-box;   /* âœ… åŒ…å«å†…è¾¹è·å’Œè¾¹æ¡† */
    margin: 6px 0;
    padding: 10px;
    border: 1px solid #aaa;
    border-radius: 5px;
    font-size: 14px;
  }
  .register-box button {
    width: 100%;              /* âœ… æŒ‰é’®ä¹Ÿç»Ÿä¸€ */
    padding: 10px;
    background: orange;
    border: none;
    border-radius: 5px;
    color: black;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  .small-btn {
    width: 100%;              /* âœ… ç‹¬å ä¸€è¡Œ */
    background: #03a9f4;
    color: white;
    padding: 8px 10px;
    font-size: 12px;
    margin: 5px 0;
    border-radius: 5px;
    cursor: pointer;
    border: none;
  }
  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 10px auto;
    display: block;
    object-fit: cover;
    border: 2px solid #666;
    background: #444;
  }
</style>

</head>
<body>
  <div class="header">
    <a href="https://htcb-12c7.github.io/htgov/">
      <img class="logo" src="https://htcb-12c7.github.io/htgov/assets/HTgovIconV2.png" alt="è¿”å›ä¸»é¡µ">
    </a>
    é»‘é“VIP æ³¨å†Œ <span></span>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <h3>é»‘é“å·¥ä½œå®¤</h3>
      <ul id="sidebar-nav"></ul>
    </div>

    <div class="content">
      <div class="container">
        <div class="register-box">
          <h2>æ³¨å†Œé»‘é“VIPè´¦å·</h2>

          <!-- æ˜µç§° -->
          <input type="text" id="regNickname" placeholder="æ˜µç§°" />
          <button type="button" class="small-btn" onclick="checkNickname()">æ£€æŸ¥æ˜µç§°</button>
          <div id="nickStatus" style="font-size:12px;color:orange;"></div>

          <!-- çœŸå®å§“å -->
          <input type="text" id="regName" placeholder="çœŸå®å§“åï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰" />

          <!-- é‚®ç®± -->
          <input type="email" id="regEmail" placeholder="é‚®ç®±" />
          <button type="button" class="small-btn" onclick="sendEmailCode()">å‘é€éªŒè¯ç </button>
          <input type="text" id="emailCode" placeholder="è¾“å…¥é‚®ç®±éªŒè¯ç " />

          <!-- å¯†ç  -->
          <input type="password" id="regPassword" placeholder="å¯†ç " />
          <input type="password" id="regConfirmPassword" placeholder="ç¡®è®¤å¯†ç " />

          <!-- âœ… ä¸Šä¼ å¤´åƒ -->
          <label style="margin-top:10px; display:block;">ä¸Šä¼ å¤´åƒ (jpg/png, â‰¤2MB)</label>
          <input type="file" id="avatarUpload" accept="image/*" />
          <img id="avatarPreview" class="avatar-preview" src="https://htcb-12c7.github.io/htgov/assets/login-placeholder.svg" alt="é¢„è§ˆå¤´åƒ" />

          <!-- æ”¯ä»˜æ–¹å¼ -->
          <select id="payType">
            <option value="">æ”¯ä»˜æ–¹å¼ï¼ˆå¯é€‰ï¼‰</option>
            <option value="bank">é“¶è¡Œå¡</option>
            <option value="wechat">å¾®ä¿¡</option>
            <option value="alipay">æ”¯ä»˜å®</option>
            <option value="zelle">Zelle</option>
            <option value="other">å…¶ä»–ï¼ˆè¯·å¡«å†™åç§°ï¼‰</option>
          </select>
          <input type="text" id="payName" placeholder="åç§°ï¼ˆä¾‹ï¼šé“¶è¡Œåç§°/å¾®ä¿¡åç§°/å…¶ä»–ï¼‰" />
          <input type="text" id="payAccount" placeholder="è´¦å·ï¼ˆä¾‹ï¼šé“¶è¡Œå¡å·/å¾®ä¿¡å·ï¼‰" />

          <button id="registerBtn">æ³¨å†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase æ³¨å†Œé€»è¾‘ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDKAAxNpKqcSsS2onwlKANl9tLmCy6UGo",
      authDomain: "ht-chat-91e5f.firebaseapp.com",
      databaseURL: "https://ht-chat-91e5f-default-rtdb.firebaseio.com",
      projectId: "ht-chat-91e5f",
      storageBucket: "ht-chat-91e5f.appspot.com",
      messagingSenderId: "325331727527",
      appId: "1:325331727527:web:d994b7241a7cc28e9dd782",
      measurementId: "G-VYV13LWP14"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let avatarFile = null;
    let avatarURL = "";

    // âœ… å®æ—¶é¢„è§ˆå¤´åƒ
    document.getElementById("avatarUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) {
        alert("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MBï¼");
        return;
      }
      avatarFile = file;
      document.getElementById("avatarPreview").src = URL.createObjectURL(file);
    });

    // âœ… æ˜µç§°æ£€æŸ¥
    window.checkNickname = async function () {
      const nick = document.getElementById("regNickname").value.trim();
      if (!nick) return alert("è¯·è¾“å…¥æ˜µç§°");
      const snapshot = await get(ref(db, "nicknames/" + nick));
      document.getElementById("nickStatus").innerText = snapshot.exists() ? "âŒ æ˜µç§°å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢" : "âœ… æ˜µç§°å¯ç”¨";
    };

    // âœ… é‚®ç®±éªŒè¯ç ï¼ˆæ¨¡æ‹Ÿï¼‰
    let emailCodeSent = "";
    window.sendEmailCode = function () {
      emailCodeSent = Math.floor(100000 + Math.random() * 900000).toString();
      alert("éªŒè¯ç ï¼ˆé»‘é“ç ï¼‰: " + emailCodeSent);
    };

    // âœ… æ³¨å†Œ
let isRegistering = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

document.getElementById("registerBtn").onclick = async () => {
  if (isRegistering) return; // å·²ç»åœ¨æ³¨å†Œä¸­ï¼Œç›´æ¥å¿½ç•¥
  isRegistering = true;

  const nickname = document.getElementById("regNickname").value.trim();
  const name = document.getElementById("regName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const code = document.getElementById("emailCode").value.trim();
  const password = document.getElementById("regPassword").value;
  const confirm = document.getElementById("regConfirmPassword").value;
  const payType = document.getElementById("payType").value;
  const payName = document.getElementById("payName").value;
  const payAccount = document.getElementById("payAccount").value;

  if (!nickname || !name || !email || !password) {
    isRegistering = false;
    return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼");
  }
  if (password !== confirm) {
    isRegistering = false;
    return alert("ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´ï¼");
  }
  if (emailCodeSent && code !== emailCodeSent) {
    isRegistering = false;
    return alert("é‚®ç®±éªŒè¯ç é”™è¯¯ï¼");
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // âœ… ä¸Šä¼ å¤´åƒ
    if (avatarFile) {
      const fileRef = sRef(storage, "avatars/" + user.uid + ".jpg");
      await uploadBytes(fileRef, avatarFile);
      avatarURL = await getDownloadURL(fileRef);
    } else {
      avatarURL = "https://htcb-12c7.github.io/htgov/assets/login-placeholder.svg";
    }

    // âœ… ä¿å­˜ç”¨æˆ·æ•°æ®
    await set(ref(db, "users/" + user.uid), {
      nickname, name, email,
      avatar: avatarURL,
      payMethod: payType,
      payName,
      payAccount
    });
    await set(ref(db, "nicknames/" + nickname), { uid: user.uid });

    alert("ğŸ‰ æ³¨å†ŒæˆåŠŸï¼");
  } catch (err) {
    if (err.code === "auth/email-already-in-use") {
      alert("è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•");
    } else {
      alert("æ³¨å†Œå¤±è´¥: " + err.message);
    }
  } finally {
    isRegistering = false; // ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œæœ€åè§£é”
  }
};
  </script>

  <!-- å¯¼èˆªåŠ è½½ -->
  <script>
    fetch("https://htcb-12c7.github.io/htgov/nav/nav.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("sidebar-nav").innerHTML = html;
      })
      .catch(err => console.error("èœå•åŠ è½½å¤±è´¥ï¼š", err));
  </script>
</body>
</html>
