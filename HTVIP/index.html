<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»‘é“VIP æ³¨å†Œ</title>
  <link rel="stylesheet" href="https://htcb-12c7.github.io/htgov/css/htgov.css" />
<style>
  .register-box {
    max-width: 400px;
    margin: 40px auto;
    padding: 20px;
    background: #222;
    color: white;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  .register-box h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  .register-box input, 
  .register-box select {
    width: 100%;              /* âœ… ç»Ÿä¸€é•¿åº¦ */
    box-sizing: border-box;   /* âœ… åŒ…å«å†…è¾¹è·å’Œè¾¹æ¡† */
    margin: 6px 0;
    padding: 10px;
    border: 1px solid #aaa;
    border-radius: 5px;
    font-size: 14px;
  }
  .register-box button {
    width: 100%;              /* âœ… æŒ‰é’®ä¹Ÿç»Ÿä¸€ */
    padding: 10px;
    background: orange;
    border: none;
    border-radius: 5px;
    color: black;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  .small-btn {
    width: 100%;              /* âœ… ç‹¬å ä¸€è¡Œ */
    background: #03a9f4;
    color: white;
    padding: 8px 10px;
    font-size: 12px;
    margin: 5px 0;
    border-radius: 5px;
    cursor: pointer;
    border: none;
  }
  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 10px auto;
    display: block;
    object-fit: cover;
    border: 2px solid #666;
    background: #444;
    /* å¤´åƒä¸Šä¼ ç»„ä»¶æ ·å¼ */
.avatar-upload-section {
  margin: 10px 0;
  text-align: center; /* æ·»åŠ è¿™ä¸€è¡Œè®©å†…å®¹å±…ä¸­ */
}

.avatar-upload-section label {
  color: #f5deb3;
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
}

.avatar-upload-section input[type="file"] {
  background: linear-gradient(145deg, #1e1e1e, #2b2b2b);
  color: #f5deb3;
  border: 1px solid #8b6914;
  padding: 6px 10px;
  border-radius: 6px;
  outline: none;
  font-size: 14px;
  box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8),
              inset -2px -2px 5px rgba(255,255,255,0.05);
  transition: all 0.3s ease;
  width: 100%;
  max-width: 250px;
  margin: 0 auto; /* æ·»åŠ è¿™ä¸€è¡Œè®©è¾“å…¥æ¡†å±…ä¸­ */
  display: block; /* æ·»åŠ è¿™ä¸€è¡Œè®©è¾“å…¥æ¡†å±…ä¸­ */
}

.avatar-upload-section input[type="file"]:focus {
  border-color: #ffd700;
  box-shadow: 0 0 6px #ffd700, inset 1px 1px 3px rgba(0,0,0,0.6);
  background: linear-gradient(145deg, #252525, #333);
}

.avatar-upload-section img {
  display: block;
  border: 2px solid #ffd700;
  margin: 10px auto; /* ä¿®æ”¹è¿™ä¸€è¡Œè®©å›¾ç‰‡å±…ä¸­ */
}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init("sbFx6huxFVrhXPqr5"); // ä½ çš„ Public Key
  })();
</script>
</head>
<body>
  <div class="header">
    <a href="https://htcb-12c7.github.io/htgov/">
      <img class="logo" src="https://htcb-12c7.github.io/htgov/assets/HTgovIconV2.png" alt="è¿”å›ä¸»é¡µ">
    </a>
    é»‘é“VIP æ³¨å†Œ <span></span>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <h3>é»‘é“å·¥ä½œå®¤</h3>
      <ul id="sidebar-nav"></ul>
    </div>

    <div class="content">
      <div class="container">
        <div class="register-box">
          <h2>æ³¨å†Œé»‘é“VIPè´¦å·</h2>

          <!-- æ˜µç§° -->
          <input type="text" id="regNickname" placeholder="æ˜µç§°" />
          <button type="button" class="small-btn" onclick="checkNickname()">æ£€æŸ¥æ˜µç§°</button>
          <div id="nickStatus" style="font-size:12px;color:orange;"></div>

          <!-- çœŸå®å§“å -->
          <input type="text" id="regName" placeholder="çœŸå®å§“åï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰" />

          <!-- é‚®ç®± -->
          <input type="email" id="regEmail" placeholder="é‚®ç®±" />
          <button type="button" class="small-btn" onclick="sendEmailCode()">å‘é€éªŒè¯ç </button>
          <input type="text" id="emailCode" placeholder="è¾“å…¥é‚®ç®±éªŒè¯ç " />

          <!-- å¯†ç  -->
          <input type="password" id="regPassword" placeholder="å¯†ç " />
          <input type="password" id="regConfirmPassword" placeholder="ç¡®è®¤å¯†ç " />

          <!-- âœ… ä¸Šä¼ å¤´åƒ -->
<!-- å¤´åƒä¸Šä¼ ç»„ä»¶ -->
<div class="avatar-upload-section">
  <label>å¤´åƒï¼š</label>
  <input type="file" id="updateAvatar" accept="image/*" />
<img id="userPhotoPreview" 
     src="https://htcb-12c7.github.io/htgov/assets/login-placeholder.svg"
     style="width:60px; height:60px; border-radius:50%; margin-top:5px;" />
</div>

<style>
/* å¤´åƒä¸Šä¼ ç»„ä»¶æ ·å¼ */
.avatar-upload-section {
  margin: 10px 0;
}

.avatar-upload-section label {
  color: #f5deb3;
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
}

.avatar-upload-section input[type="file"] {
  background: linear-gradient(145deg, #1e1e1e, #2b2b2b);
  color: #f5deb3;
  border: 1px solid #8b6914;
  padding: 6px 10px;
  border-radius: 6px;
  outline: none;
  font-size: 14px;
  box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8),
              inset -2px -2px 5px rgba(255,255,255,0.05);
  transition: all 0.3s ease;
  width: 100%;
  max-width: 250px;
}

.avatar-upload-section input[type="file"]:focus {
  border-color: #ffd700;
  box-shadow: 0 0 6px #ffd700, inset 1px 1px 3px rgba(0,0,0,0.6);
  background: linear-gradient(145deg, #252525, #333);
}

.avatar-upload-section img {
  display: block;
  border: 2px solid #ffd700;
}
</style>

<script>
// å¤´åƒä¸Šä¼ åŠŸèƒ½
let newAvatarFile = null;

// åˆå§‹åŒ–å¤´åƒä¸Šä¼ åŠŸèƒ½
function initAvatarUpload() {
  const avatarInput = document.getElementById("updateAvatar");
  const previewImg = document.getElementById("userPhotoPreview");
  
  if (avatarInput) {
    avatarInput.addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å° (27MBé™åˆ¶)
      if (file.size > 27 * 1024 * 1024) {
        alert("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡27MBï¼");
        return;
      }
      
      newAvatarFile = file;
      
      // é¢„è§ˆå›¾ç‰‡
      previewImg.src = URL.createObjectURL(file);
    });
  }
}

// è·å–é€‰ä¸­çš„å¤´åƒæ–‡ä»¶
function getAvatarFile() {
  return newAvatarFile;
}

// é‡ç½®å¤´åƒä¸Šä¼ çŠ¶æ€
function resetAvatarUpload() {
  newAvatarFile = null;
  const previewImg = document.getElementById("userPhotoPreview");
  if (previewImg) {
    previewImg.src = "assets/login-placeholder.svg";
  }
  const avatarInput = document.getElementById("updateAvatar");
  if (avatarInput) {
    avatarInput.value = "";
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initAvatarUpload);
</script>

          <!-- æ”¯ä»˜æ–¹å¼ -->
          <select id="payType">
            <option value="">æ”¯ä»˜æ–¹å¼ï¼ˆå¯é€‰ï¼‰</option>
            <option value="bank">é“¶è¡Œå¡</option>
            <option value="wechat">å¾®ä¿¡</option>
            <option value="alipay">æ”¯ä»˜å®</option>
            <option value="zelle">Zelle</option>
            <option value="other">å…¶ä»–ï¼ˆè¯·å¡«å†™åç§°ï¼‰</option>
          </select>
          <input type="text" id="payName" placeholder="åç§°ï¼ˆä¾‹ï¼šé“¶è¡Œåç§°/å¾®ä¿¡åç§°/å…¶ä»–ï¼‰" />
          <input type="text" id="payAccount" placeholder="è´¦å·ï¼ˆä¾‹ï¼šé“¶è¡Œå¡å·/å¾®ä¿¡å·ï¼‰" />

          <button id="registerBtn">æ³¨å†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase æ³¨å†Œé€»è¾‘ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDKAAxNpKqcSsS2onwlKANl9tLmCy6UGo",
      authDomain: "ht-chat-91e5f.firebaseapp.com",
      databaseURL: "https://ht-chat-91e5f-default-rtdb.firebaseio.com",
      projectId: "ht-chat-91e5f",
      storageBucket: "ht-chat-91e5f.appspot.com",
      messagingSenderId: "325331727527",
      appId: "1:325331727527:web:d994b7241a7cc28e9dd782",
      measurementId: "G-VYV13LWP14"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let avatarFile = null;
    let avatarURL = "";

// âœ… å®æ—¶é¢„è§ˆå¤´åƒ - ä½¿ç”¨æ–°çš„å¤´åƒä¸Šä¼ ç»„ä»¶
document.getElementById("updateAvatar").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 27 * 1024 * 1024) {
    alert("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡27MBï¼");
    return;
  }
  avatarFile = file;
  document.getElementById("userPhotoPreview").src = URL.createObjectURL(file);
});

    // âœ… æ˜µç§°æ£€æŸ¥
    window.checkNickname = async function () {
      const nick = document.getElementById("regNickname").value.trim();
      if (!nick) return alert("è¯·è¾“å…¥æ˜µç§°");
      const snapshot = await get(ref(db, "nicknames/" + nick));
      document.getElementById("nickStatus").innerText = snapshot.exists() ? "âŒ æ˜µç§°å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢" : "âœ… æ˜µç§°å¯ç”¨";
    };


// âœ… é‚®ç®±éªŒè¯ç  Email JS
let emailCodeSent = "";
let emailCodeExpire = 0;   // éªŒè¯ç è¿‡æœŸæ—¶é—´æˆ³
let isSendingCode = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

window.sendEmailCode = function () {
  const email = document.getElementById("regEmail").value.trim();
  if (!email) return alert("è¯·è¾“å…¥é‚®ç®±");

  // é‚®ç®±æ ¼å¼æ ¡éªŒ
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    return alert("è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼");
  }

  // é˜²æ­¢é‡å¤ç‚¹å‡»
  if (isSendingCode) return alert("éªŒè¯ç å‘é€ä¸­ï¼Œè¯·ç¨å€™...");
  isSendingCode = true;

  // ç”ŸæˆéªŒè¯ç  + è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ7åˆ†é’Ÿï¼‰
  emailCodeSent = Math.floor(100000 + Math.random() * 900000).toString();
  emailCodeExpire = Date.now() + 7 * 60 * 1000; // å½“å‰æ—¶é—´+7åˆ†é’Ÿ

  // è°ƒç”¨ EmailJS å‘é€
  emailjs.send("htcoutlook01", "htgov_code", {
    to_email: email,
    code: emailCodeSent
  })
  .then(() => {
    alert("éªŒè¯ç å·²å‘é€åˆ°é‚®ç®±ï¼Œè¯·åœ¨7åˆ†é’Ÿå†…ä½¿ç”¨ï¼");
  })
  .catch((err) => {
    console.error("å‘é€å¤±è´¥:", err);
    alert("éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
  })
  .finally(() => {
    isSendingCode = false; // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è§£é”
  });
};

    // âœ… æ³¨å†Œ
let isRegistering = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

document.getElementById("registerBtn").onclick = async () => {
  if (isRegistering) return; // å·²ç»åœ¨æ³¨å†Œä¸­ï¼Œç›´æ¥å¿½ç•¥
  isRegistering = true;

  const nickname = document.getElementById("regNickname").value.trim();
  const name = document.getElementById("regName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const code = document.getElementById("emailCode").value.trim();
  const password = document.getElementById("regPassword").value;
  const confirm = document.getElementById("regConfirmPassword").value;
  const payType = document.getElementById("payType").value;
  const payName = document.getElementById("payName").value;
  const payAccount = document.getElementById("payAccount").value;

  if (!nickname || !name || !email || !password) {
    isRegistering = false;
    return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼");
  }
  if (password !== confirm) {
    isRegistering = false;
    return alert("ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´ï¼");
  }
if (emailCodeSent) {
  if (Date.now() > emailCodeExpire) {
    isRegistering = false;
    return alert("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–ï¼");
  }
  if (code !== emailCodeSent) {
    isRegistering = false;
    return alert("é‚®ç®±éªŒè¯ç é”™è¯¯ï¼");
  }
}

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // âœ… ä¸Šä¼ å¤´åƒ
    if (avatarFile) {
      const fileRef = sRef(storage, "avatars/" + user.uid + ".jpg");
      await uploadBytes(fileRef, avatarFile);
      avatarURL = await getDownloadURL(fileRef);
    } else {
      avatarURL = "https://htcb-12c7.github.io/htgov/assets/login-placeholder.svg";
    }

    // âœ… ä¿å­˜ç”¨æˆ·æ•°æ®
    await set(ref(db, "users/" + user.uid), {
      nickname, name, email,
      avatar: avatarURL,
      payMethod: payType,
      payName,
      payAccount
    });
    await set(ref(db, "nicknames/" + nickname), { uid: user.uid });

    alert("ğŸ‰ æ³¨å†ŒæˆåŠŸï¼");
  } catch (err) {
    if (err.code === "auth/email-already-in-use") {
      alert("è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•");
    } else {
      alert("æ³¨å†Œå¤±è´¥: " + err.message);
    }
  } finally {
    isRegistering = false; // ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œæœ€åè§£é”
  }
};
  </script>

  <!-- å¯¼èˆªåŠ è½½ -->
  <script>
    fetch("https://htcb-12c7.github.io/htgov/nav/nav.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("sidebar-nav").innerHTML = html;
      })
      .catch(err => console.error("èœå•åŠ è½½å¤±è´¥ï¼š", err));
  </script>
</body>
</html>
