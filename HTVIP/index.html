<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>黑铁VIP 注册</title>
  <link rel="stylesheet" href="https://htcb-12c7.github.io/htgov/css/htgov.css" />
<style>
  .register-box {
    max-width: 400px;
    margin: 40px auto;
    padding: 20px;
    background: #222;
    color: white;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  .register-box h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  .register-box input, 
  .register-box select {
    width: 100%;              /* ✅ 统一长度 */
    box-sizing: border-box;   /* ✅ 包含内边距和边框 */
    margin: 6px 0;
    padding: 10px;
    border: 1px solid #aaa;
    border-radius: 5px;
    font-size: 14px;
  }
  .register-box button {
    width: 100%;              /* ✅ 按钮也统一 */
    padding: 10px;
    background: orange;
    border: none;
    border-radius: 5px;
    color: black;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  .small-btn {
    width: 100%;              /* ✅ 独占一行 */
    background: #03a9f4;
    color: white;
    padding: 8px 10px;
    font-size: 12px;
    margin: 5px 0;
    border-radius: 5px;
    cursor: pointer;
    border: none;
  }
  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 10px auto;
    display: block;
    object-fit: cover;
    border: 2px solid #666;
    background: #444;
  }
</style>

</head>
<body>
  <div class="header">
    <a href="https://htcb-12c7.github.io/htgov/">
      <img class="logo" src="https://htcb-12c7.github.io/htgov/assets/HTgovIconV2.png" alt="返回主页">
    </a>
    黑铁VIP 注册 <span></span>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <h3>黑铁工作室</h3>
      <ul id="sidebar-nav"></ul>
    </div>

    <div class="content">
      <div class="container">
        <div class="register-box">
          <h2>注册黑铁VIP账号</h2>

          <!-- 昵称 -->
          <input type="text" id="regNickname" placeholder="昵称" />
          <button type="button" class="small-btn" onclick="checkNickname()">检查昵称</button>
          <div id="nickStatus" style="font-size:12px;color:orange;"></div>

          <!-- 真实姓名 -->
          <input type="text" id="regName" placeholder="真实姓名（中文/英文）" />

          <!-- 邮箱 -->
          <input type="email" id="regEmail" placeholder="邮箱" />
          <button type="button" class="small-btn" onclick="sendEmailCode()">发送验证码</button>
          <input type="text" id="emailCode" placeholder="输入邮箱验证码" />

          <!-- 密码 -->
          <input type="password" id="regPassword" placeholder="密码" />
          <input type="password" id="regConfirmPassword" placeholder="确认密码" />

          <!-- ✅ 上传头像 -->
          <label style="margin-top:10px; display:block;">上传头像 (jpg/png, ≤2MB)</label>
          <input type="file" id="avatarUpload" accept="image/*" />
          <img id="avatarPreview" class="avatar-preview" src="https://htcb-12c7.github.io/htgov/assets/login-placeholder.svg" alt="预览头像" />

          <!-- 支付方式 -->
          <select id="payType">
            <option value="">支付方式（可选）</option>
            <option value="bank">银行卡</option>
            <option value="wechat">微信</option>
            <option value="alipay">支付宝</option>
            <option value="zelle">Zelle</option>
            <option value="other">其他（请填写名称）</option>
          </select>
          <input type="text" id="payName" placeholder="名称（例：银行名称/微信名称/其他）" />
          <input type="text" id="payAccount" placeholder="账号（例：银行卡号/微信号）" />

          <button id="registerBtn">注册</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase 注册逻辑 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDKAAxNpKqcSsS2onwlKANl9tLmCy6UGo",
      authDomain: "ht-chat-91e5f.firebaseapp.com",
      databaseURL: "https://ht-chat-91e5f-default-rtdb.firebaseio.com",
      projectId: "ht-chat-91e5f",
      storageBucket: "ht-chat-91e5f.appspot.com",
      messagingSenderId: "325331727527",
      appId: "1:325331727527:web:d994b7241a7cc28e9dd782",
      measurementId: "G-VYV13LWP14"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let avatarFile = null;
    let avatarURL = "";

    // ✅ 实时预览头像
    document.getElementById("avatarUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) {
        alert("图片大小不能超过2MB！");
        return;
      }
      avatarFile = file;
      document.getElementById("avatarPreview").src = URL.createObjectURL(file);
    });

    // ✅ 昵称检查
    window.checkNickname = async function () {
      const nick = document.getElementById("regNickname").value.trim();
      if (!nick) return alert("请输入昵称");
      const snapshot = await get(ref(db, "nicknames/" + nick));
      document.getElementById("nickStatus").innerText = snapshot.exists() ? "❌ 昵称已存在，请更换" : "✅ 昵称可用";
    };

    // ✅ 邮箱验证码（模拟）
    let emailCodeSent = "";
    window.sendEmailCode = function () {
      emailCodeSent = Math.floor(100000 + Math.random() * 900000).toString();
      alert("验证码（黑铁码）: " + emailCodeSent);
    };

    // ✅ 注册
let isRegistering = false; // 防止重复点击

document.getElementById("registerBtn").onclick = async () => {
  if (isRegistering) return; // 已经在注册中，直接忽略
  isRegistering = true;

  const nickname = document.getElementById("regNickname").value.trim();
  const name = document.getElementById("regName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const code = document.getElementById("emailCode").value.trim();
  const password = document.getElementById("regPassword").value;
  const confirm = document.getElementById("regConfirmPassword").value;
  const payType = document.getElementById("payType").value;
  const payName = document.getElementById("payName").value;
  const payAccount = document.getElementById("payAccount").value;

  if (!nickname || !name || !email || !password) {
    isRegistering = false;
    return alert("请填写完整信息！");
  }
  if (password !== confirm) {
    isRegistering = false;
    return alert("两次密码输入不一致！");
  }
  if (emailCodeSent && code !== emailCodeSent) {
    isRegistering = false;
    return alert("邮箱验证码错误！");
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // ✅ 上传头像
    if (avatarFile) {
      const fileRef = sRef(storage, "avatars/" + user.uid + ".jpg");
      await uploadBytes(fileRef, avatarFile);
      avatarURL = await getDownloadURL(fileRef);
    } else {
      avatarURL = "https://htcb-12c7.github.io/htgov/assets/login-placeholder.svg";
    }

    // ✅ 保存用户数据
    await set(ref(db, "users/" + user.uid), {
      nickname, name, email,
      avatar: avatarURL,
      payMethod: payType,
      payName,
      payAccount
    });
    await set(ref(db, "nicknames/" + nickname), { uid: user.uid });

    alert("🎉 注册成功！");
  } catch (err) {
    if (err.code === "auth/email-already-in-use") {
      alert("该邮箱已注册，请直接登录");
    } else {
      alert("注册失败: " + err.message);
    }
  } finally {
    isRegistering = false; // 不管成功失败，最后解锁
  }
};
  </script>

  <!-- 导航加载 -->
  <script>
    fetch("https://htcb-12c7.github.io/htgov/nav/nav.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("sidebar-nav").innerHTML = html;
      })
      .catch(err => console.error("菜单加载失败：", err));
  </script>
</body>
</html>
